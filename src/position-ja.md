# 箱庭（Hakoniwa）の立ち位置
— 分散シミュレーション実行基盤における設計前提・評価軸・意味論 —

## 1. はじめに（Purpose & Scope）
本資料は、分散シミュレーション／協調シミュレーション技術における箱庭（Hakoniwa）の立ち位置を、既存技術との優劣比較ではなく、
- どのような問題設定を前提とし
- 何を保証し、何を保証しないか
- どの評価軸に基づいて設計されているか
という観点から明確化することを目的とする。

比較対象として、以下を参照する。
- HLA（High Level Architecture）
- FMI（Functional Mock-up Interface, 特に Co-Simulation）
- 箱庭（Hakoniwa）

本資料は、歴史的経緯や実装細部の網羅を目的とせず、設計思想と意味論的立ち位置の明確化に焦点を当てる。

## 2. 用語定義
### 2.1 時間・実行に関する用語
- 論理時間（Logical Time）: シミュレーションモデル上で定義される時間軸。
- 実時間（Wall-clock Time）: 現実世界の経過時間。
- ΔT: 数値計算や通信における更新ステップ幅。
- d_max（最大許容遅延時間）: 分散実行においてシステム設計時に設定される最大通信遅延の上限。

### 2.2 箱庭固有の用語
- 箱庭アセット（Hakoniwa Asset）: OSプロセスとして実行される単位。一つまたは複数の Execution Unit（EU）を内部に保持する。
- Execution Unit（EU）: 分散環境において同一の論理モデルを表す実行主体。EU は論理的存在であり、複数アセット上に実体を持ちうる。
- Owner / Non-Owner: EU に対して状態更新および PDU 書き込み責任を持つ主体／持たない主体。
- Epoch: EU に対する実行責任（Owner）が一意に定まっている実行権限の世代番号。
- Commit Point: Conductor による状態遷移に基づき、Epoch の更新が全体で合意され、当該 Epoch の実行結果と実行責任が意味論的に確定する境界点。
- Runtime Delegation（RD）: 実行中に EU の Owner を安全に切り替えるための機構。
- Conductor（箱庭コンダクタ）: EU に対する実行責任の状態遷移を管理し、Epoch の更新および Commit Point の成立を制御する主体。Conductor は数値計算を行わず、実行戦略や解法を決定しない。また、状態遷移の判断は外部から与えられたポリシーに基づいて行われるが、ポリシーの具体的内容や最適性は箱庭の規定外である。

## 3. 問題設定：分散実行で何が破綻を引き起こすか
箱庭は、次の問いを設計出発点とする。

分散シミュレーションにおいて本当に破綻を引き起こすのは、
時間の微小なズレそのものなのか、
それとも 実行責任と因果関係の曖昧化 なのか。

分散環境では、通信遅延や並列実行により時間ズレは不可避である。箱庭は、このズレ自体を排除するのではなく、ズレが存在しても因果と責任が破綻しない構造を設計対象とする。

## 4. 既存技術の前提整理
### 4.1 FMI（特に FMI-CS）
FMI は、数値モデル（FMU）の交換・結合を目的としたインターフェース規格である。
- FMU の入出力と依存関係は定義される
- 実行順序・ステップ制御・遅延処理はマスターアルゴリズム（MA）に委ねられる

FMI は、あえて MA を規格外とすることで、多様な数値解法やツール実装を許容している。その結果、分散実行における因果性や遅延の扱いは規格としては保証されない。

### 4.2 HLA
HLA は、分散イベント／論理時間シミュレーションの枠組みである。
- RTI が論理時間進行と因果順序を管理
- 時間整合性と再現性が最上位概念

HLA は、時間と因果をシステム全体で強制的に管理する立場を取る。

### 4.3 比較の整理
整理すると、
- FMI は「モデル交換と結合」に焦点を当て
- HLA は「時間と因果の管理」を支配する枠組みである
これに対し箱庭は、「分散実行における実行責任の管理」に焦点を当てている。

## 5. 箱庭の設計前提（Core Assumptions）
箱庭は、以下を前提として設計されている。
- 分散実行では時間ズレは必ず発生する
- 実行性能（リアルタイム、またはそれ以上）を最優先する
- 全体論理時間の厳密整合は目的としない
- 実行責任と因果境界は曖昧にしない

## 6. 箱庭の中核機構
### 6.1 有界ドリフトに基づく時刻同期
箱庭は、最大許容遅延時間 d_max に基づく有界ドリフト型の分散時刻同期機構を採用する。

本機構は、各アセットが並列実行を継続することを前提とし、全体の厳密な時刻整合を目的としない。代わりに、分散実行中の時刻ズレが常に制御可能な上限内に収まることを保証する。

具体的な保証は、実行構成に依存して次のように与えられる。
- 単一ノード内で複数アセットが実行される構成では、任意のアセット間のシミュレーション時刻差は常に d_max 以下に抑えられる。
- サーバー 1 台と複数クライアントからなる分散構成では、クライアント A → サーバー → クライアント B という転送経路における上り遅延と下り遅延の和を想定する。各方向の遅延が最大 d_max の場合、往復で 2·d_max となるため、任意のクライアント間のシミュレーション時刻差は常に 2·d_max 以下に抑えられる。

これらの保証は、論理時間の世界では常に成立する。

一方で、実時間として、通信遅延が d_max を超過した場合、箱庭は時間整合を回復するための自動補正を行わない。そのような状況は、設計時に想定した動作条件の範囲外として扱われ、実行停止や再構成といった上位の運用判断に委ねられる。

この機構は、因果性や実行責任の確定を保証するものではない。それらは Runtime Delegation および Commit Point によって別途意味論的に扱われる。

### 6.2 Runtime Delegation（RD）
Runtime Delegation（RD）は、Conductor によって管理される EU の状態遷移を通じて実現される。
- Epoch により実行責任の世代を管理
- Commit Point において因果と責任を確定
- Commit Point と新 Owner の実行開始は一致しない場合がある

これは、Commit Point が意味論的な確定点であるのに対し、新 Owner の起動および実行開始は分散環境におけるプロセス生成や通信に依存するためである。この時間差は、分散実行において必然的に生じるものであり、箱庭ではその存在を前提として設計されている。

RD は、フェイルオーバーや負荷分散を主目的としない。分散実行における責任と因果の一意性を維持するための設計原理である。

## 7. 箱庭が決めていること／決めていないこと
### 7.1 箱庭が決めていること
- EU に対する Owner は常に一意
- PDU の書き込み責任は曖昧にならない
- 時刻ズレは有界（d_max または 2·d_max）
- Commit Point において因果と責任が確定
- Conductor による実行責任遷移の管理

### 7.2 箱庭が決めていないこと
- 数値解法（Jacobi / Gauss–Seidel 等）
- RD を発動する判断ポリシー
- 実行配置・負荷分散の最適化戦略
- 遅延データの数値的な扱い（古い値をそのまま使用するか、補間するか、外挿するか等）

これらはユーザに委ねられる設計自由度である。

## 8. 評価軸の明示
箱庭は、以下を主要な評価軸として採用する。

1. 実行性能: リアルタイム、またはそれ以上の速度での分散実行。
2. 有界性（Bounded Drift）: 時刻ズレが常に制御可能な範囲に収まること。
3. 実行責任の一意性: 任意の時点で実行主体が曖昧にならないこと。
4. 意味論的確定性: Commit Point において因果境界が明示的に確定すること。

箱庭は、以下を第一評価軸としない。
- 全体論理時間での完全再現性
- 浮動小数点演算レベルの一致
- 自動最適化された実行戦略

箱庭は、破綻を防ぐための必要最小限の意味論のみを基盤として提供する。

## 9. 適用が想定されるユースケース（参考）
### 9.1 箱庭が適している状況
箱庭は、以下のような状況に適している。
- リアルタイム制約を持つ HILS（Hardware-in-the-Loop Simulation）
- 実行中に計算負荷や配置条件が変化する環境における協調シミュレーション（エッジ・クラウド間の計算オフロードなど）
- ノード障害時の動的な実行責任切替を伴うシステム

### 9.2 箱庭が適さない状況
以下のような場合には、箱庭以外の選択肢がより適している可能性がある。
- 完全な再現性が必須の検証シミュレーション（浮動小数点演算レベルでの一致が要求される場合）
- 実行性能よりも論理時間の厳密な整合性を最優先する必要がある場合

## 10. 技術比較マトリクス（参考）
以下の表は、HLA、FMI、箱庭の設計上の焦点を整理したものである。

## 11. 位置づけのまとめ
箱庭（Hakoniwa）は、有界な時間ドリフトを許容する分散実行モデルの上に、
因果と実行責任の一意性を意味論的に付与する分散シミュレーション実行基盤である。

箱庭は、時間整合性を強制する基盤でも、数値解法を規定する基盤でもない。
高性能な分散実行を前提とし、破綻を防ぐために必要最小限の意味論のみを規定する点に、その設計上の立ち位置がある。

また箱庭は、時間同期を中心とする従来の分散シミュレーション理論を否定するものではなく、異なる失敗モードと要求条件を持つ問題領域に対する補完的アプローチとして位置づけられる。

## 著者注
本資料は、各技術の優劣を示すものではなく、問題設定・前提・評価軸の違いを明確化することを目的とする。

## 13. FAQ — よくある質問と批判的検討
### 13.1 設計思想に関する質問
**Q1. 「実行責任」は時間管理の不備を隠すための概念ではないか？**  
**A:** これは問題の次元を混同した批判である。箱庭における時間管理と実行責任は、異なる層の問題に対応している。

- 時間管理（物理層）：「いつ」データが生成されたか
- 実行責任（意味論層）：「誰が」そのデータに責任を持つか

現実の分散システム（例：金融取引、データベースのトランザクション）では、物理的な時刻同期よりも「誰の確定操作によってこの状態になったか」という責任の所在が重要である。

箱庭は、分散システム理論におけるCAP定理（一貫性・可用性・分断耐性を同時に満たすことは不可能）に対する現実的な解答として、可用性（実行性能）を優先し、一貫性を「有界ドリフト」という形で制御可能な範囲に保証している。

実行責任という概念は、時間管理の不備を隠すためではなく、分散システムにおける因果関係を時間とは独立に確定するための、より高次の設計原理である。

**Q2. なぜ時間の完全同期を諦めるのか？**  
**A:** 諦めているのではなく、現実を直視した設計判断である。

分散環境では、以下の物理的制約により完全な時間同期は達成不可能である：
- ネットワーク遅延の変動
- 処理負荷の非対称性
- クロックドリフト

HLAのような厳密な時間管理は、これらの制約に対して「全コンポーネントが同期するまで待機」という戦略を取る。これは以下の状況で問題となる：

1. リアルタイム性が最優先の場合（例：HILS）
   - 1つのコンポーネントの遅延がシステム全体の停止を招く
   - いわゆる「船団方式」の限界

2. 動的に構成が変化する場合（例：エッジ・クラウド協調）
   - ノード追加・削除のたびに全体同期が必要

箱庭は、時間の完全同期という「達成不可能な理想」を追うのではなく、「制御可能な範囲内でのズレ」と「明確な責任の所在」という「達成可能な保証」を提供することを選択している。

**Q3. 有界ドリフト保証の成立条件は何か？**  
**A:** 箱庭の有界ドリフト保証は、設計時に定義された最大許容遅延時間 d_max の範囲内で成立する。

d_max はシステム設計時に与えられる動作条件であり、この条件が満たされている限り、論理時間上の時刻ズレは常に有界に保たれる。

一方で、通信遅延が d_max を超過した場合、それは設計時に想定した動作条件の範囲外とみなされる。箱庭はそのような状況に対して、時間整合を回復するための自動補正を行わない。

これは、分散システムにおける責任範囲を明確に分離するためである。
フレームワークは、設計条件内での動作保証を担い、条件外の異常事態への対応は、実行停止や再構成といった上位の運用判断に委ねられる。

### 13.2 実装・運用に関する質問
**Q4. 数値解法や遅延データの扱いを「ユーザーに委ねる」のは責任放棄ではないか？**  
**A:** これは責任放棄ではなく、戦略的な設計判断である。

箱庭の設計哲学: 「意味論的破綻を防ぐ最小限のルール」のみを提供し、ドメイン固有の最適化はドメイン専門家（ユーザー）に委ねる。

これはUnix哲学の "Do one thing and do it well" と同じ考え方である。

比較例：プログラミング言語
- Java：メモリ管理を言語が強制（安全だが制約）
- C++：メモリ管理を開発者に委任（危険だが柔軟）

どちらが正しいかは用途による。箱庭は後者の哲学を採用している。

箱庭が「決めないこと」の理由：
- 数値解法：ある問題ではJacobi法が、別の問題ではGauss-Seidel法が適切。汎用フレームワークが特定解法を強制すると、他の解法を使いたいユーザーにとって制約になる。
- 遅延データの扱い：あるシミュレーションでは補間が適切だが、別のシミュレーションでは古い値をそのまま使うべき場合もある。

箱庭が規定するのは「誰のデータが正か」という責任の所在のみであり、そのデータをどう数値的に扱うかはドメイン知識が必要な判断である。

**Q5. Commit Pointと新Ownerの実行開始がズレることの実害は？**  
**A:** これは実害ではなく、分散実行の現実を正直に反映した設計である。

例：組織における役職交代
- Commit Point：社長が「今日付で新部長を任命」と宣言（意味論的確定）
- 実行開始：新部長が実際に業務を開始（物理的開始）

引き継ぎ期間があるため、この2つは一致しない。しかし責任の所在は明確：
- Commit Point以前の事象 → 前任者の責任
- Commit Point以降の事象 → 新任者の責任

箱庭も同様に、Commit Pointで責任の境界を意味論的に確定する。新Ownerのプロセス起動や通信には物理的な時間がかかるが、責任の所在に曖昧さはない。

むしろ、この2つが常に一致すると仮定する方が、分散システムの現実を無視した不誠実な設計といえる。

### 13.3 適用範囲に関する質問
**Q7. 科学的検証シミュレーションには使えないのか？**  
**A:** 用途による。箱庭は適用範囲を明確に宣言している：

適している状況：
- リアルタイム性が最優先（HILS）
- 動的な負荷変動・構成変化（エッジ・クラウド協調）
- ノード障害時の動的な実行責任切替

適さない状況：
- 浮動小数点演算レベルでの完全再現性が必須
- 実行性能よりも論理時間の厳密整合を最優先

重要な視点：HLAにも適用限界がある。
- 10ms以内の応答が必須のリアルタイムシステム
- 全ノードの同期待ちがボトルネックになる大規模分散環境

技術選定は「どちらが優れているか」ではなく、「どちらが要件に適合するか」で判断すべきである。

箱庭が「科学的検証に不向き」と明示しているのは、弱点を隠すためではなく、誠実な設計判断を示すためである。

**Q8. HLAと箱庭、どちらを選ぶべきか？**  
**A:** 以下の判断基準を推奨する：

両者の関係は「対立」ではなく「棲み分け」である。

箱庭は、HLAが対応困難な領域（性能最優先、動的変化）に明確な解を提供する。逆に、HLAは箱庭が対応しない領域（完全再現性）での標準的選択肢である。

**Q9. FMIとの違いは何か？**  
**A:** 主な違いは以下の通り：

FMI（特にFMI-CS）：
- 焦点：モデル交換と結合のインターフェース規格
- マスターアルゴリズム（MA）を規格外とする
- 結果：分散実行における因果性や責任は保証されない

箱庭：
- 焦点：分散実行における実行責任の管理
- 責任の所在（Owner）を常に明確化
- 結果：因果性はCommit Pointで意味論的に確定

箱庭は、FMIが「決めないこと」を選んだ領域（実行責任と因果性）に、明確な意味論を提供する立場にある。
